<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        :root{--primary:#007AFF;--bg:#1c1c1e;--pad:6px;--line-height:1.4;--font-family:-apple-system,"Microsoft YaHei",sans-serif}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{width:100%;height:100%;margin:0;padding:0;background-color:var(--bg);font-family:var(--font-family);overflow:hidden;user-select:none}
        ::-webkit-scrollbar,#scrollWindow::-webkit-scrollbar,body::-webkit-scrollbar{display:none!important;width:0!important;height:0!important;background:transparent}
        #scrollWindow{position:absolute;top:0;left:0;right:0;bottom:0;overflow:auto;-webkit-overflow-scrolling:touch;z-index:1;touch-action:pan-x pan-y;display:flex;align-items:flex-start;scrollbar-width:none;-ms-overflow-style:none}
        #sizingContainer{position:relative;margin:0 auto;flex-shrink:0;transform-origin:0 0;will-change:width,height;opacity:0;transition:opacity .1s ease-out}
        #sizingContainer.visible{opacity:1}
        #contentLayer{position:absolute;top:0;left:0;transform-origin:0 0;padding-top:80px;padding-bottom:200px;will-change:transform}
        .page-container{position:relative;background:white;box-shadow:0 4px 15px rgba(0,0,0,.3);display:block;margin-bottom:15px;backface-visibility:hidden}
        .page-container canvas{display:block;width:100%;height:100%;pointer-events:none}
        #customScrollbarTrack{position:fixed;right:2px;top:60px;bottom:40px;width:20px;z-index:3500;pointer-events:none}
        #scrollThumb{position:absolute;right:2px;width:6px;min-height:40px;background:rgba(255,255,255,.75);border-radius:3px;box-shadow:0 0 4px rgba(0,0,0,.8),0 0 1px rgba(0,0,0,.5) inset;border:1px solid rgba(255,255,255,.3);pointer-events:auto;opacity:0;transition:opacity .3s;touch-action:none}
        #scrollThumb.active{opacity:1}
        #scrollThumb::after{content:'';position:absolute;top:-10px;bottom:-10px;left:-15px;right:-10px}
        .toolbar{position:fixed;top:0;left:0;right:0;height:auto;background:rgba(245,245,247,.95);backdrop-filter:blur(20px);padding:10px 16px;display:flex;flex-direction:column;gap:8px;z-index:2000;box-shadow:0 4px 20px rgba(0,0,0,.15);transition:transform .3s cubic-bezier(.25,1,.5,1);transform:translateY(0)}
        .toolbar.hidden{transform:translateY(-100%)}
        .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
        .label-text{font-size:12px;color:#555;white-space:nowrap;width:30px}
        .btn{padding:6px 14px;border-radius:16px;border:none;font-weight:600;font-size:13px;color:#333;background:#e5e5ea;cursor:pointer;transition:all .2s}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-active{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(0,122,255,.3)}
        .btn:disabled{background:#ccc;color:#fff}
        #triggerColorBtn{width:32px;height:32px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,.2)}
        #centerOpenBtn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:15px;color:#888;z-index:10;pointer-events:none}
        #centerOpenBtn button{pointer-events:auto}
        .page-pill{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);backdrop-filter:blur(10px);color:#fff;padding:6px 16px;border-radius:20px;font-size:12px;pointer-events:none;z-index:3000}
        .annotation-item,.input-box{position:absolute;font-family:var(--font-family);font-weight:bold;line-height:var(--line-height);padding:var(--pad);z-index:100;white-space:pre;border-radius:4px;transform-origin:0 0;min-width:10px;min-height:1em}
        .annotation-item{border:1px solid transparent}
        .annotation-item.selected{border:1px solid var(--primary);background:rgba(0,122,255,.1);z-index:101}
        .input-box{background:rgba(255,255,255,.95);border:1px solid var(--primary);outline:none;resize:none;box-shadow:0 4px 15px rgba(0,0,0,.15);z-index:200;overflow:hidden}
        .del-btn{position:absolute;font-size:1em;width:1.3em;height:1.3em;top:-.65em;right:-.65em;align-items:center;justify-content:center;background:#FF3B30;color:#fff;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,.3);z-index:102;display:none;cursor:pointer;pointer-events:auto}
        .del-btn::before{content:'Ã—';font-size:.9em;line-height:1}
        .annotation-item.selected .del-btn{display:flex}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:4000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
        .modal-overlay.active{opacity:1;pointer-events:auto}
        .color-panel{background:#fff;width:90%;max-width:380px;border-radius:20px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,.2);display:flex;flex-direction:column;gap:16px}
        .cp-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:2px}
        .cp-cell{width:100%;padding-top:100%;border-radius:4px;cursor:pointer;position:relative}
        .cp-cell.active::after{content:'';position:absolute;top:2px;left:2px;right:2px;bottom:2px;border:2px solid #fff;border-radius:2px;box-shadow:0 0 2px rgba(0,0,0,.5)}
        .alpha-container{height:24px;border-radius:12px;background-color:#fff;background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:10px 10px;position:relative;overflow:hidden}
        #alphaSlider{width:100%;height:100%;-webkit-appearance:none;appearance:none;background:linear-gradient(to right,transparent,var(--slider-color,#000));outline:none;cursor:pointer;margin:0;display:block}
        #alphaSlider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;background:#fff;border:2px solid #ddd;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.2)}
        .cp-footer{display:flex;align-items:center;gap:15px;height:50px}
        .curr-preview{width:50px;height:50px;border-radius:12px;flex-shrink:0;border:1px solid rgba(0,0,0,.1)}
        .presets-wrapper{flex:1;overflow-x:auto;display:flex;align-items:center;gap:12px;padding:4px;scrollbar-width:none}
        .presets-wrapper::-webkit-scrollbar{display:none}
        .preset-dot{width:32px;height:32px;border-radius:50%;flex-shrink:0;border:1px solid rgba(0,0,0,.1);cursor:pointer;transition:transform .2s,opacity .2s}
        .add-btn{width:32px;height:32px;border-radius:50%;flex-shrink:0;background:#1a1a1a;color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
    </style>
</head>
<body>

<div class="toolbar" id="mainToolbar">
    <div class="row">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ æ‰“å¼€</button>
        <button id="annotToggleBtn" class="btn" onclick="toggleAnnotMode()">âœ æ‰¹æ³¨</button>
        <div id="triggerColorBtn" onclick="openColorModal()" style="background-color:rgba(255,59,48,1)"></div>
        <button id="saveBtn" class="btn btn-primary" onclick="savePDF()" disabled>ğŸ’¾ ä¿å­˜</button>
    </div>
    <div class="row">
        <span class="label-text">å­—å·</span>
        <input type="range" style="flex:1;height:4px" min="5" max="60" value="14" oninput="updateSize(this.value)">
        <span id="sizeVal" style="font-size:12px;width:20px;text-align:right">14</span>
    </div>
    <div class="row">
        <span class="label-text">ç¼©æ”¾</span>
        <input type="range" id="zoomSlider" style="flex:1;height:4px" min="0.5" max="4.0" step="0.1" value="1.0" oninput="handleSliderZoom(this.value)">
        <span id="zoomVal" style="font-size:12px;width:20px;text-align:right">1.0</span>
    </div>
    <input type="file" id="fileInput" accept="application/pdf" style="display:none">
</div>

<div id="centerOpenBtn">
    <div style="font-size:40px">ğŸ“„</div>
    <button class="btn" onclick="document.getElementById('fileInput').click()">æ‰“å¼€ PDF æ–‡ä»¶</button>
</div>

<div id="scrollWindow">
    <div id="sizingContainer">
        <div id="contentLayer"></div>
    </div>
</div>

<div id="customScrollbarTrack"><div id="scrollThumb"></div></div>
<div class="page-pill" id="pageInd">è¯·æ‰“å¼€æ–‡ä»¶</div>

<div class="modal-overlay" id="colorModal" onclick="closeColorModal(event)">
    <div class="color-panel" onclick="event.stopPropagation()">
        <div class="cp-grid" id="colorGrid"></div>
        <div class="alpha-container"><input type="range" id="alphaSlider" min="0" max="1" step="0.01" value="1"></div>
        <div class="cp-footer">
            <div id="previewBox" class="curr-preview"></div>
            <div class="presets-wrapper" id="presetContainer"></div>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:10px" onclick="closeColorModal(null,true)">ç¡®å®š</button>
    </div>
</div>

<script>
    /* ===== å¸¸é‡ ===== */
    var PAD = 6, LH = 1.4, BW = 1;
    var FF = '-apple-system, "Microsoft YaHei", sans-serif';

    /* ===== å…¨å±€çŠ¶æ€ ===== */
    var isAnnotMode = false, isToolbarVisible = true;
    var originalFileBuffer = null, pdfDoc = null, totalPages = 0;
    var currentFontSize = 14;
    var colorState = { r: 255, g: 59, b: 48, a: 1.0 };
    var annotations = {};
    var lastBlurTS = 0, justDeleted = false;
    var scaleState = 1.0, baseWidth = 0, baseHeight = 0;
    var pageObserver = null;
    var pageInfoMap = {};

    var scrollWindow = document.getElementById('scrollWindow');
    var sizingContainer = document.getElementById('sizingContainer');
    var contentLayer = document.getElementById('contentLayer');
    var zoomSlider = document.getElementById('zoomSlider');
    var zoomValDisplay = document.getElementById('zoomVal');
    var scrollThumb = document.getElementById('scrollThumb');
    var scrollTrack = document.getElementById('customScrollbarTrack');

    /* ===== DOM æ–‡å­—æµ‹é‡ ===== */
    var _mSpan = document.createElement('span');
    _mSpan.style.cssText = 'position:fixed;left:-99999px;top:-99999px;visibility:hidden;' +
        'white-space:pre;font-weight:bold;padding:0;border:0;margin:0;' +
        'line-height:' + LH + ';font-family:' + FF;
    document.body.appendChild(_mSpan);

    function measureLine(text, fs) {
        _mSpan.style.fontSize = fs + 'px';
        _mSpan.textContent = text || '\u00A0';
        return _mSpan.getBoundingClientRect();
    }

    /*
     * ã€æ–°å¢ã€‘ç²¾ç¡®æµ‹é‡ DOM åŸºçº¿ä½ç½®
     * åŸç†ï¼šé›¶é«˜åº¦ inline-block çš„åº•è¾¹æ°å¥½è½åœ¨çˆ¶çº§æ–‡å­—åŸºçº¿ä¸Šï¼Œ
     *       ç”¨å®ƒçš„ topï¼ˆ= bottomï¼‰å‡å»å®¹å™¨ top å°±å¾—åˆ°"è¡Œæ¡†é¡¶éƒ¨åˆ°åŸºçº¿çš„è·ç¦»"ã€‚
     */
    function measureBaselineOffset(fontSize) {
        var div = document.createElement('div');
        div.style.cssText = 'position:absolute;left:-9999px;top:-9999px;' +
            'font-family:' + FF + ';font-size:' + fontSize + 'px;font-weight:bold;' +
            'line-height:' + LH + ';white-space:nowrap;padding:0;margin:0;border:0;';
        var text = document.createElement('span');
        text.textContent = 'Mgä¸­æµ‹ABC';
        var probe = document.createElement('span');
        probe.style.cssText = 'display:inline-block;vertical-align:baseline;width:1px;height:0;overflow:hidden;';
        div.appendChild(text);
        div.appendChild(probe);
        document.body.appendChild(div);
        var result = probe.getBoundingClientRect().top - div.getBoundingClientRect().top;
        document.body.removeChild(div);
        return result;
    }

    /* ===== localStorage ===== */
    var SK_C = 'pdfpro_color', SK_P = 'pdfpro_presets';
    var DEF_P = ['rgba(255, 59, 48, 1)', 'rgba(0, 122, 255, 1)', 'rgba(0, 0, 0, 1)'];

    function saveColor() { try { localStorage.setItem(SK_C, JSON.stringify(colorState)); } catch (e) {} }
    function loadColor() { try { var s = localStorage.getItem(SK_C); if (s) { var p = JSON.parse(s); if (typeof p.r === 'number') colorState = p; } } catch (e) {} }
    function savePresets() { try { var a = []; document.querySelectorAll('#presetContainer .preset-dot').forEach(function(d) { a.push(d.getAttribute('data-color')); }); localStorage.setItem(SK_P, JSON.stringify(a)); } catch (e) {} }
    function loadPresetList() { try { var s = localStorage.getItem(SK_P); var a = s ? JSON.parse(s) : null; return (a && Array.isArray(a) && a.length > 0) ? a : DEF_P; } catch (e) { return DEF_P; } }

    function createPresetDot(colorStr) {
        var dot = document.createElement('div');
        dot.className = 'preset-dot';
        dot.style.backgroundColor = colorStr;
        dot.setAttribute('data-color', colorStr);
        var timer = null, isLP = false;
        dot.addEventListener('touchstart', function() {
            isLP = false;
            timer = setTimeout(function() {
                isLP = true;
                dot.style.transform = 'scale(0)'; dot.style.opacity = '0';
                setTimeout(function() { dot.remove(); savePresets(); }, 250);
            }, 500);
        }, { passive: true });
        dot.addEventListener('touchend', function() { clearTimeout(timer); if (!isLP) applyPreset(dot.getAttribute('data-color')); });
        dot.addEventListener('touchmove', function() { clearTimeout(timer); });
        dot.onclick = function() { applyPreset(dot.getAttribute('data-color')); };
        return dot;
    }

    function buildPresetUI() {
        var w = document.getElementById('presetContainer'); w.innerHTML = '';
        var list = loadPresetList();
        for (var i = 0; i < list.length; i++) w.appendChild(createPresetDot(list[i]));
        var ab = document.createElement('div'); ab.className = 'add-btn'; ab.textContent = '+'; ab.onclick = addCurrentToPreset; w.appendChild(ab);
    }

    /* ===== è¿”å›é”® ===== */
    function handleBackPress() {
        var m = document.getElementById('colorModal');
        if (m.classList.contains('active')) { m.classList.remove('active'); return true; }
        if (document.querySelector('.annotation-item.selected')) { deselectAll(); return true; }
        if (isAnnotMode) { toggleAnnotMode(); return true; }
        return false;
    }

    /* ===== æ»šåŠ¨æ¡ ===== */
    var scrollTimer = null, isThumbDrag = false, thumbDSY = 0, thumbDSST = 0;

    function updateScrollThumb() {
        var st = scrollWindow.scrollTop, sH = scrollWindow.scrollHeight, cH = scrollWindow.clientHeight;
        if (sH <= cH) { scrollThumb.style.opacity = '0'; return; }
        scrollThumb.classList.add('active');
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(function() { if (!isThumbDrag) scrollThumb.classList.remove('active'); }, 1500);
        var tH = scrollTrack.clientHeight, thH = Math.max(40, (cH / sH) * tH), mT = tH - thH;
        scrollThumb.style.height = thH + 'px';
        scrollThumb.style.transform = 'translateY(' + (st / (sH - cH)) * mT + 'px)';
    }

    scrollThumb.addEventListener('touchstart', function(e) {
        e.preventDefault(); e.stopPropagation();
        isThumbDrag = true; scrollThumb.classList.add('active');
        thumbDSY = e.touches[0].clientY; thumbDSST = scrollWindow.scrollTop;
    }, { passive: false });

    window.addEventListener('touchmove', function(e) {
        if (!isThumbDrag) return; e.preventDefault();
        var dy = e.touches[0].clientY - thumbDSY;
        var tH = scrollTrack.clientHeight, thH = parseFloat(scrollThumb.style.height) || 40, mT = tH - thH;
        if (mT <= 0) return;
        scrollWindow.scrollTop = thumbDSST + (dy / mT) * (scrollWindow.scrollHeight - scrollWindow.clientHeight);
    }, { passive: false });

    window.addEventListener('touchend', function() {
        if (isThumbDrag) { isThumbDrag = false; setTimeout(function() { scrollThumb.classList.remove('active'); }, 1000); }
    });

    scrollWindow.addEventListener('scroll', updateScrollThumb);
    window.addEventListener('resize', updateScrollThumb);

    /* ===== å·¥å…·æ  ===== */
    function toggleToolbar(f) {
        var t = document.getElementById('mainToolbar');
        if (f !== undefined) isToolbarVisible = f; else isToolbarVisible = !isToolbarVisible;
        if (isToolbarVisible) { t.classList.remove('hidden'); if (window.Android && window.Android.toggleStatusBar) window.Android.toggleStatusBar(true); }
        else { t.classList.add('hidden'); if (window.Android && window.Android.toggleStatusBar) window.Android.toggleStatusBar(false); }
    }

    scrollWindow.addEventListener('click', function(e) {
        if (justDeleted) { justDeleted = false; return; }
        if (document.querySelector('.annotation-item.selected')) {
            if (!e.target.closest('.annotation-item.selected') && !e.target.closest('.del-btn')) { deselectAll(); return; }
        }
        if (e.target.closest('.input-box') || e.target.closest('.annotation-item') || e.target.closest('.del-btn')) return;
        if (isAnnotMode) { if (Date.now() - lastBlurTS < 200) return; return; }
        toggleToolbar();
    });

    /* ===== é¢œè‰² ===== */
    function rgbaStr(c) { return 'rgba(' + c.r + ', ' + c.g + ', ' + c.b + ', ' + c.a + ')'; }
    function hex2rgb(h) { var r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h); return r ? { r: parseInt(r[1], 16), g: parseInt(r[2], 16), b: parseInt(r[3], 16) } : { r: 0, g: 0, b: 0 }; }
    function parseRgba(s) {
        if (!s) return { r: 0, g: 0, b: 0, a: 1 };
        var m = s.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+)\s*)?\)/);
        if (!m) return { r: 0, g: 0, b: 0, a: 1 };
        return { r: +m[1], g: +m[2], b: +m[3], a: m[4] != null ? +m[4] : 1 };
    }

    var gridColors = ['#FFFFFF','#E6E6E6','#CCCCCC','#B3B3B3','#999999','#808080','#666666','#333333','#000000','#FFEBEE','#FFCDD2','#EF9A9A','#E57373','#EF5350','#F44336','#E53935','#D32F2F','#C62828','#F3E5F5','#E1BEE7','#CE93D8','#BA68C8','#AB47BC','#9C27B0','#8E24AA','#7B1FA2','#6A1B9A','#E3F2FD','#BBDEFB','#90CAF9','#64B5F6','#42A5F5','#2196F3','#1E88E5','#1976D2','#1565C0','#E0F2F1','#B2DFDB','#80CBC4','#4DB6AC','#26A69A','#009688','#00897B','#00796B','#00695C','#F1F8E9','#DCEDC8','#C5E1A5','#AED581','#9CCC65','#8BC34A','#7CB342','#689F38','#558B2F','#FFFDE7','#FFF9C4','#FFF59D','#FFF176','#FFEE58','#FFEB3B','#FDD835','#FBC02D','#F9A825','#FFF3E0','#FFE0B2','#FFCC80','#FFB74D','#FFA726','#FF9800','#FB8C00','#F57C00','#EF6C00'];

    function initColorGrid() {
        var g = document.getElementById('colorGrid'); g.innerHTML = '';
        gridColors.forEach(function(hex) {
            var c = document.createElement('div'); c.className = 'cp-cell'; c.style.backgroundColor = hex;
            c.onclick = function() { var rgb = hex2rgb(hex); colorState.r = rgb.r; colorState.g = rgb.g; colorState.b = rgb.b; updateModalUI(); document.querySelectorAll('.cp-cell').forEach(function(x) { x.classList.remove('active'); }); c.classList.add('active'); };
            g.appendChild(c);
        });
    }

    function openColorModal() { updateModalUI(); document.getElementById('colorModal').classList.add('active'); }
    function closeColorModal(e, f) { if (f || (e && e.target && e.target.id === 'colorModal')) { document.getElementById('colorModal').classList.remove('active'); saveColor(); } }
    document.getElementById('alphaSlider').addEventListener('input', function(e) { colorState.a = parseFloat(e.target.value); updateModalUI(); });
    function applyPreset(s) { colorState = parseRgba(s); updateModalUI(); }
    function addCurrentToPreset() { var w = document.getElementById('presetContainer'), ab = w.querySelector('.add-btn'), c = rgbaStr(colorState); w.insertBefore(createPresetDot(c), ab); w.scrollTo({ left: w.scrollWidth, behavior: 'smooth' }); savePresets(); }
    function updateModalUI() { var c = rgbaStr(colorState); document.getElementById('alphaSlider').style.setProperty('--slider-color', 'rgb(' + colorState.r + ',' + colorState.g + ',' + colorState.b + ')'); document.getElementById('alphaSlider').value = colorState.a; document.getElementById('previewBox').style.backgroundColor = c; document.getElementById('triggerColorBtn').style.backgroundColor = c; }
    function toggleAnnotMode() { isAnnotMode = !isAnnotMode; var b = document.getElementById('annotToggleBtn'); if (isAnnotMode) { b.classList.add('btn-active'); b.innerText = 'âœ æ‰¹æ³¨ä¸­'; toggleToolbar(true); } else { b.classList.remove('btn-active'); b.innerText = 'âœ æ‰¹æ³¨'; deselectAll(); } }
    function updateSize(v) { currentFontSize = +v; document.getElementById('sizeVal').innerText = v; }

    initColorGrid(); loadColor(); buildPresetUI(); updateModalUI();

    /* ===== æ–‡ä»¶åŠ è½½ ===== */
    document.getElementById('fileInput').addEventListener('change', function(e) {
        var file = e.target.files[0]; if (!file) return;
        var reader = new FileReader();
        reader.onload = async function(ev) {
            originalFileBuffer = ev.target.result.slice(0);
            try {
                pdfDoc = await pdfjsLib.getDocument({ data: originalFileBuffer.slice(0) }).promise;
                totalPages = pdfDoc.numPages; annotations = {}; pageInfoMap = {};
                document.getElementById('centerOpenBtn').style.display = 'none';
                document.getElementById('saveBtn').disabled = false;
                await initView(); toggleToolbar(true);
            } catch (err) { alert('è§£æå¤±è´¥: ' + err.message); }
        };
        reader.readAsArrayBuffer(file); this.value = '';
    });

    async function initView() {
        sizingContainer.classList.remove('visible');
        contentLayer.innerHTML = ''; scrollWindow.scrollTop = 0;
        if (pageObserver) { pageObserver.disconnect(); pageObserver = null; }

        var p1 = await pdfDoc.getPage(1);
        var vp1 = p1.getViewport({ scale: 1 });
        var screenW = window.innerWidth;
        var initialScale = (screenW - 20) / vp1.width;
        var maxW = 0, totalH = 80;

        for (var i = 1; i <= totalPages; i++) {
            var pd = document.createElement('div');
            pd.className = 'page-container'; pd.id = 'page-' + i; pd.setAttribute('data-page', i);

            var page = await pdfDoc.getPage(i);
            var vpOrig = page.getViewport({ scale: 1 });
            var vpBase = page.getViewport({ scale: initialScale });
            var cssW = Math.floor(vpBase.width);
            var cssH = Math.floor(vpBase.height);

            pageInfoMap[i] = {
                cssW: cssW, cssH: cssH,
                pdfW: vpOrig.width, pdfH: vpOrig.height,
                scale: initialScale
            };

            var maxDim = 4096, rScale = initialScale * 2;
            var vpTest = page.getViewport({ scale: rScale });
            if (vpTest.width > maxDim || vpTest.height > maxDim) {
                rScale *= Math.min(maxDim / vpTest.width, maxDim / vpTest.height);
            }
            var vpRender = page.getViewport({ scale: rScale });

            pd.style.width = cssW + 'px'; pd.style.height = cssH + 'px';
            contentLayer.appendChild(pd);

            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = vpRender.width; canvas.height = vpRender.height;
            await page.render({ canvasContext: ctx, viewport: vpRender }).promise;
            pd.appendChild(canvas);

            if (vpBase.width > maxW) maxW = vpBase.width;
            totalH += vpBase.height + 15;
        }

        baseWidth = maxW; baseHeight = totalH;
        contentLayer.style.width = baseWidth + 'px';
        contentLayer.style.height = baseHeight + 'px';
        scaleState = 1.0; zoomSlider.value = 1.0; zoomValDisplay.innerText = '1.0';
        updateZoomLayout(); setupPageObserver();
        requestAnimationFrame(function() {
            requestAnimationFrame(function() { sizingContainer.classList.add('visible'); });
        });
    }

    function setupPageObserver() {
        pageObserver = new IntersectionObserver(function(entries) {
            var maxR = 0, best = null;
            entries.forEach(function(en) {
                if (en.isIntersecting && en.intersectionRatio > maxR) { maxR = en.intersectionRatio; best = en.target.getAttribute('data-page'); }
            });
            if (best) document.getElementById('pageInd').innerText = best + ' / ' + totalPages;
        }, { threshold: [0.1, 0.3, 0.5, 0.7], root: scrollWindow });
        document.querySelectorAll('.page-container').forEach(function(el) { pageObserver.observe(el); });
    }

    /* ===== ç¼©æ”¾ ===== */
    function updateZoomLayout() {
        contentLayer.style.transform = 'scale(' + scaleState + ')';
        sizingContainer.style.width = (baseWidth * scaleState) + 'px';
        sizingContainer.style.height = (baseHeight * scaleState) + 'px';
        zoomSlider.value = scaleState.toFixed(1); zoomValDisplay.innerText = scaleState.toFixed(1);
        updateScrollThumb();
    }

    function applyZoom(ns) {
        var os = scaleState, r = scrollWindow.getBoundingClientRect();
        var vcx = r.width / 2, vcy = r.height / 2;
        var sl = scrollWindow.scrollLeft, st = scrollWindow.scrollTop;
        var cw = baseWidth * os, clo = cw < r.width ? (r.width - cw) / 2 : 0;
        var ax = (sl + vcx - clo) / os, ay = (st + vcy) / os;
        scaleState = ns; updateZoomLayout();
        var nw = baseWidth * ns, nlo = nw < r.width ? (r.width - nw) / 2 : 0;
        scrollWindow.scrollLeft = Math.max(0, nw <= r.width ? 0 : (ax * ns) + nlo - vcx);
        scrollWindow.scrollTop = Math.max(0, (ay * ns) - vcy);
    }

    function handleSliderZoom(v) { applyZoom(+v); }

    var startDist = 0, pinchSS = 1, isZooming = false, rafP = false;
    scrollWindow.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) { e.preventDefault(); isZooming = true; startDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY); pinchSS = scaleState; }
    }, { passive: false });
    scrollWindow.addEventListener('touchmove', function(e) {
        if (isZooming && e.touches.length === 2) { e.preventDefault(); if (rafP) return; rafP = true; var cx1 = e.touches[0].clientX, cy1 = e.touches[0].clientY, cx2 = e.touches[1].clientX, cy2 = e.touches[1].clientY; requestAnimationFrame(function() { var d = Math.hypot(cx2 - cx1, cy2 - cy1); if (d > 0 && startDist > 0) applyZoom(Math.max(0.5, Math.min(4.0, pinchSS * (d / startDist)))); rafP = false; }); }
    }, { passive: false });
    scrollWindow.addEventListener('touchend', function(e) { if (e.touches.length < 2) isZooming = false; });

    /* ===== æ‰¹æ³¨ç³»ç»Ÿ ===== */
    function deselectAll() { document.querySelectorAll('.annotation-item.selected').forEach(function(el) { el.classList.remove('selected'); }); }

    contentLayer.addEventListener('click', function(e) {
        if (justDeleted) { justDeleted = false; return; }
        if (document.querySelector('.annotation-item.selected')) { deselectAll(); return; }
        if (Date.now() - lastBlurTS < 200) return;
        if (!isAnnotMode) return;
        if (e.target.closest('.annotation-item') || e.target.closest('.input-box') || e.target.closest('.del-btn')) return;
        var pg = e.target.closest('.page-container'); if (!pg) return;
        var rect = pg.getBoundingClientRect();
        var sc = rect.width / parseFloat(pg.style.width);
        var xR = (e.clientX - rect.left) / sc, yR = (e.clientY - rect.top) / sc;
        var edge = PAD + BW;
        var boxH = currentFontSize * LH + edge * 2;
        createNewInput(pg, xR - edge, yR - boxH / 2, '');
    });

    /* ===== createNewInput ===== */
    function createNewInput(wrapper, xPx, yPx, initText, unused, optFS, optClr) {
        document.querySelectorAll('textarea.input-box').forEach(function(t) { t.blur(); });
        var pNum = wrapper.getAttribute('data-page');
        var id = Date.now();
        var fs = optFS || currentFontSize;
        var clr = optClr || rgbaStr(colorState);
        var pgW = parseFloat(wrapper.style.width);
        var pgH = parseFloat(wrapper.style.height);
        var edge = PAD + BW;

        var input = document.createElement('textarea');
        input.className = 'input-box';
        input.style.left = (xPx / pgW * 100) + '%';
        input.style.top = (yPx / pgH * 100) + '%';
        input.style.fontSize = fs + 'px';
        input.style.color = clr;
        input.value = initText || '';
        input.rows = 1;

        var autoResize = function() {
            var val = input.value || '\u00A0';
            var lines = val.split('\n');
            var maxLW = 0, lineH = 0;
            for (var i = 0; i < lines.length; i++) {
                var m = measureLine(lines[i], fs);
                if (m.width > maxLW) maxLW = m.width;
                if (m.height > lineH) lineH = m.height;
            }
            var tw = Math.max(28, Math.ceil(maxLW) + edge * 2);
            var th = Math.ceil(lineH * lines.length) + edge * 2;
            input.style.width = tw + 'px'; input.style.height = th + 'px';
        };

        input.addEventListener('input', autoResize);
        input.addEventListener('touchstart', function(ev) { ev.stopPropagation(); });

        input.onblur = function() {
            lastBlurTS = Date.now();
            var val = input.value;
            if (val && val.trim().length > 0) {
                var pageRect = wrapper.getBoundingClientRect();
                var inputRect = input.getBoundingClientRect();
                var effScale = pageRect.width / pgW;
                var realW = inputRect.width / effScale;
                var realH = inputRect.height / effScale;
                saveData(pNum, id, xPx, yPx, val, fs, clr, realW, realH);
                createStaticDiv(wrapper, id, xPx, yPx, val, fs, clr, realW, realH);
            }
            input.remove();
        };

        wrapper.appendChild(input); autoResize();
        setTimeout(function() { input.focus(); if (initText) input.setSelectionRange(initText.length, initText.length); }, 10);
    }

    /* ===== makeDraggable ===== */
    function makeDraggable(el, page, onDragEnd, onTap) {
        var isDrag = false, dsx, dsy, dsl, dst, moved = false;
        var moveH = function(e) {
            if (!isDrag) return; e.preventDefault();
            var t = e.touches ? e.touches[0] : e;
            var dx = t.clientX - dsx, dy = t.clientY - dsy;
            if (Math.hypot(dx, dy) > 5) moved = true;
            var pr = page.getBoundingClientRect(), sc = pr.width / parseFloat(page.style.width);
            var pw = parseFloat(page.style.width), ph = parseFloat(page.style.height);
            el.style.left = Math.max(0, Math.min(95, dsl + (dx / sc) / pw * 100)) + '%';
            el.style.top = Math.max(0, Math.min(98, dst + (dy / sc) / ph * 100)) + '%';
        };
        var endH = function() {
            if (!isDrag) return; isDrag = false;
            window.removeEventListener('touchmove', moveH); window.removeEventListener('touchend', endH);
            window.removeEventListener('mousemove', moveH); window.removeEventListener('mouseup', endH);
            if (!moved) { if (onTap) onTap(); }
            else { if (onDragEnd) { var pw = parseFloat(page.style.width), ph = parseFloat(page.style.height); onDragEnd(parseFloat(el.style.left) / 100 * pw, parseFloat(el.style.top) / 100 * ph); } }
        };
        var startH = function(e) {
            if (e.target.closest('.del-btn')) return;
            e.preventDefault(); e.stopPropagation();
            var t = e.touches ? e.touches[0] : e;
            dsx = t.clientX; dsy = t.clientY; dsl = parseFloat(el.style.left); dst = parseFloat(el.style.top);
            isDrag = true; moved = false;
            window.addEventListener('touchmove', moveH, { passive: false }); window.addEventListener('touchend', endH);
            window.addEventListener('mousemove', moveH); window.addEventListener('mouseup', endH);
        };
        el.addEventListener('touchstart', startH, { passive: false }); el.addEventListener('mousedown', startH);
    }

    /* ===== createStaticDiv ===== */
    function createStaticDiv(wrapper, id, xPx, yPx, text, size, color, wCss, hCss) {
        var pgW = parseFloat(wrapper.style.width), pgH = parseFloat(wrapper.style.height);
        var div = document.createElement('div');
        div.className = 'annotation-item'; div.innerText = text;
        div.style.left = (xPx / pgW * 100) + '%'; div.style.top = (yPx / pgH * 100) + '%';
        div.style.fontSize = size + 'px'; div.style.color = color;
        div.style.width = wCss + 'px'; div.style.height = hCss + 'px';

        var delBtn = document.createElement('div'); delBtn.className = 'del-btn';
        var delHandled = false;
        var delHandler = function(e) {
            e.stopPropagation(); e.stopImmediatePropagation(); e.preventDefault();
            if (delHandled) return; delHandled = true; justDeleted = true;
            removeData(wrapper.getAttribute('data-page'), id); div.remove();
            setTimeout(function() { delHandled = false; }, 300);
        };
        delBtn.addEventListener('touchstart', delHandler, { passive: false });
        delBtn.addEventListener('click', delHandler);
        div.appendChild(delBtn);

        makeDraggable(div, wrapper,
            function(nxPx, nyPx) { updateDataPosition(wrapper.getAttribute('data-page'), id, nxPx, nyPx); },
            function() {
                if (div.classList.contains('selected')) {
                    var pNum = wrapper.getAttribute('data-page');
                    var item = annotations[pNum] ? annotations[pNum].find(function(a) { return a.id === id; }) : null;
                    var sx = item ? item.xPx : xPx, sy = item ? item.yPx : yPx;
                    var ss = item ? item.size : size, sc = item ? item.color : color;
                    div.remove(); removeData(pNum, id);
                    createNewInput(wrapper, sx, sy, text, null, ss, sc);
                } else { deselectAll(); div.classList.add('selected'); }
            }
        );
        wrapper.appendChild(div);
    }

    /* ===== æ•°æ®ç®¡ç† ===== */
    function saveData(p, id, x, y, text, size, color, w, h) {
        if (!p) return; if (!annotations[p]) annotations[p] = [];
        annotations[p] = annotations[p].filter(function(a) { return a.id !== id; });
        annotations[p].push({ id: id, xPx: x, yPx: y, text: text, size: size, color: color, wCss: w, hCss: h });
    }
    function updateDataPosition(p, id, nx, ny) {
        if (!p || !annotations[p]) return;
        var it = annotations[p].find(function(a) { return a.id === id; });
        if (it) { it.xPx = nx; it.yPx = ny; }
    }
    function removeData(p, id) {
        if (!p || !annotations[p]) return;
        annotations[p] = annotations[p].filter(function(a) { return a.id !== id; });
    }

    /* ===== PDF ä¿å­˜ ===== */

    /*
     * ã€æ ¸å¿ƒä¿®å¤ v3ã€‘captureAnnotation
     *
     * v1 åŸå§‹é—®é¢˜ï¼šç”¨ actualBoundingBoxAscent ç®—åŸºçº¿ â†’ å¤§å­—ä¸Šç§»ã€å°å­—ç¼©çŸ­
     * v2 ä¿®äº†æ°´å¹³ç¼©æ”¾ + middle åŸºçº¿ â†’ å¤§å­—å’Œæ¨ªå‘OKäº†ï¼Œä½†å°å­—çºµå‘è¢«å‹æ‰
     *     åŸå› ï¼šåªåšäº† scaleX æ²¡åš scaleYï¼Œcanvas å­—å½¢æ¯” DOM çŸ®ï¼Œ
     *           æ°´å¹³æ‹‰å®½åé«˜åº¦æ²¡è·Ÿä¸Š â†’ è§†è§‰ä¸Šå˜æˆäº†"çŸ®èƒ–"
     *
     * v3 æœ€ç»ˆæ–¹æ¡ˆï¼ˆä¸‰å±‚ä¿éšœï¼‰ï¼š
     *   â‘  åŸºçº¿å®šä½ï¼šç”¨ DOM å®æµ‹åŸºçº¿åç§» + textBaseline='alphabetic'
     *      â†’ æœ€å¯é çš„ canvas åŸºçº¿æ¨¡å¼ï¼Œä½ç½®å®Œå…¨æ¥è‡ª DOMï¼Œä¸çŒœä¸ç®—
     *   â‘¡ æ°´å¹³ç¼©æ”¾ï¼šscaleX = DOMæ–‡å­—å®½ / canvasæ–‡å­—å®½
     *      â†’ æ¶ˆé™¤ä¸¤ä¸ªæ¸²æŸ“å¼•æ“çš„å­—å®½å·®å¼‚
     *   â‘¢ çºµå‘ç¼©æ”¾ï¼šscaleY = scaleXï¼ˆç­‰æ¯”ç¼©æ”¾ï¼‰
     *      â†’ canvas å­—å½¢å¦‚æœçª„ï¼Œé€šå¸¸ä¹ŸçŸ®ï¼Œç”¨ç›¸åŒæ¯”ä¾‹è¡¥å¿æœ€è‡ªç„¶
     *      â†’ å›´ç»• alphabetic åŸºçº¿ç¼©æ”¾ï¼Œä¸Šä¸‹å¯¹ç§°å±•å¼€ï¼Œä¸ä¼šåç§»
     */
    function captureAnnotation(text, fontSize, colorStr, wCss, hCss) {
        var DPR = 8;
        var cW = Math.round(wCss * DPR);
        var cH = Math.round(hCss * DPR);
        if (cW <= 0 || cH <= 0 || cW > 16384 || cH > 16384) return { data: new Uint8Array(0) };

        var edge = (PAD + BW) * DPR;
        var fontPx = fontSize * DPR;

        /* DOM è¡Œé«˜ï¼ˆå’Œ autoResize ä¸€è‡´çš„æµ‹é‡æ–¹å¼ï¼‰ */
        var cssLineH = measureLine('Mgä¸­', fontSize).height;
        var canvasLineH = cssLineH * DPR;

        /* DOM åŸºçº¿åç§»ï¼šè¡Œæ¡†é¡¶éƒ¨åˆ° alphabetic åŸºçº¿çš„ç²¾ç¡®è·ç¦» */
        var baselineCSS = measureBaselineOffset(fontSize);
        var baselinePx = baselineCSS * DPR;

        var canvas = document.createElement('canvas');
        canvas.width = cW; canvas.height = cH;
        var ctx = canvas.getContext('2d');

        ctx.font = 'bold ' + fontPx + 'px ' + FF;
        ctx.fillStyle = colorStr;
        ctx.textBaseline = 'alphabetic';

        var lines = text.split('\n');
        for (var i = 0; i < lines.length; i++) {
            var lineText = lines[i];
            if (!lineText) continue;

            /* åŸºçº¿ Y = é¡¶éƒ¨è¾¹è· + ç¬¬ i è¡Œèµ·å§‹ + DOM æµ‹å¾—çš„åŸºçº¿åç§» */
            var baseY = edge + i * canvasLineH + baselinePx;

            /* æ°´å¹³ç¼©æ”¾ï¼šDOM å®½åº¦ / canvas å®½åº¦ */
            var domLineW = measureLine(lineText, fontSize).width;
            var canvasLineW = ctx.measureText(lineText).width;
            var scaleX = (canvasLineW > 0 && domLineW > 0)
                ? (domLineW * DPR) / canvasLineW
                : 1;

            /*
             * çºµå‘ç¼©æ”¾ = æ¨ªå‘ç¼©æ”¾ï¼ˆç­‰æ¯”ï¼‰
             * åŸç†ï¼šåŒä¸€å­—ä½“åœ¨ canvas vs DOM çš„å°ºå¯¸åå·®æ˜¯å…¨å±€æ€§çš„ï¼Œ
             * æ¨ªå‘åå¤šå°‘ï¼Œçºµå‘ä¹Ÿå¤§è‡´åå¤šå°‘ã€‚ç­‰æ¯”ç¼©æ”¾ä¿æŒå­—å½¢æ¯”ä¾‹ä¸å˜å½¢ã€‚
             * ç¼©æ”¾ä¸­å¿ƒ = translate çš„ç‚¹ = åŸºçº¿ä½ç½®ï¼Œæ‰€ä»¥æ–‡å­—ä¸Šä¸‹å¯¹ç§°å±•å¼€ã€‚
             */
            var scaleY = scaleX;

            ctx.save();
            ctx.translate(edge, baseY);
            ctx.scale(scaleX, scaleY);
            ctx.fillText(lineText, 0, 0);
            ctx.restore();
        }

        var url = canvas.toDataURL('image/png');
        var bs = atob(url.split(',')[1]);
        var buf = new ArrayBuffer(bs.length);
        var u8 = new Uint8Array(buf);
        for (var j = 0; j < bs.length; j++) u8[j] = bs.charCodeAt(j);
        return { data: u8 };
    }

    async function savePDF() {
        var btn = document.getElementById('saveBtn');
        btn.disabled = true; btn.innerText = 'ç”Ÿæˆä¸­...';
        try {
            var pdfDocOut = await PDFLib.PDFDocument.load(originalFileBuffer.slice(0));
            var pages = pdfDocOut.getPages();

            var hasAny = false;
            for (var k in annotations) { if (annotations[k] && annotations[k].length > 0) { hasAny = true; break; } }
            if (!hasAny) { alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„æ‰¹æ³¨'); return; }

            for (var pKey in annotations) {
                var pIdx = parseInt(pKey) - 1;
                if (pIdx < 0 || pIdx >= pages.length) continue;
                var page = pages[pIdx];
                var info = pageInfoMap[parseInt(pKey)];
                if (!info) continue;

                var ratio = 1.0 / info.scale;

                for (var ai = 0; ai < annotations[pKey].length; ai++) {
                    var a = annotations[pKey][ai];
                    var imgResult = captureAnnotation(a.text, a.size, a.color, a.wCss, a.hCss);
                    if (imgResult.data.length === 0) continue;

                    var pngImage = await pdfDocOut.embedPng(imgResult.data);

                    var boxW = a.wCss * ratio;
                    var boxH = a.hCss * ratio;
                    var pdfX = a.xPx * ratio;
                    var pdfY = info.pdfH - (a.yPx * ratio) - boxH;

                    page.drawImage(pngImage, { x: pdfX, y: pdfY, width: boxW, height: boxH });
                }
            }

            var base64Pdf = await pdfDocOut.saveAsBase64();
            var fileName = 'æ‰¹æ³¨æ–‡ä»¶_' + Date.now() + '.pdf';

            if (window.Android && window.Android.saveBase64Pdf) {
                window.Android.saveBase64Pdf(base64Pdf, fileName);
            } else {
                var link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + base64Pdf;
                link.download = fileName; link.click();
            }
        } catch (err) {
            console.error(err); alert('ä¿å­˜é”™è¯¯: ' + err.message);
        } finally {
            btn.disabled = false; btn.innerText = 'ğŸ’¾ ä¿å­˜';
        }
    }
</script>
</body>
</html>